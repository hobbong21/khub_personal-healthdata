name: Scheduled Tasks

on:
  schedule:
    # Run dependency updates check every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  dependency-check:
    name: Check Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Check frontend dependencies
      run: |
        cd frontend
        echo "## Frontend Dependencies" >> $GITHUB_STEP_SUMMARY
        npm outdated || true
    
    - name: Check backend dependencies
      run: |
        cd backend
        echo "## Backend Dependencies" >> $GITHUB_STEP_SUMMARY
        npm outdated || true
    
    - name: Create issue if updates available
      uses: actions/github-script@v6
      with:
        script: |
          const title = 'ðŸ“¦ Weekly Dependency Update Check';
          const body = 'Automated dependency check found updates available. Please review and update dependencies.';
          
          // Check if issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'dependencies'
          });
          
          const existingIssue = issues.data.find(issue => issue.title === title);
          
          if (!existingIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['dependencies', 'automated']
            });
          }

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Run npm audit (Frontend)
      run: |
        cd frontend
        npm audit --audit-level=moderate > audit-frontend.txt || true
    
    - name: Run npm audit (Backend)
      run: |
        cd backend
        npm audit --audit-level=moderate > audit-backend.txt || true
    
    - name: Upload audit results
      uses: actions/upload-artifact@v3
      with:
        name: security-audit-results
        path: |
          frontend/audit-frontend.txt
          backend/audit-backend.txt
        retention-days: 30

  cleanup-old-artifacts:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    
    steps:
    - name: Delete old artifacts
      uses: c-hive/gha-remove-artifacts@v1
      with:
        age: '30 days'
        skip-recent: 5
