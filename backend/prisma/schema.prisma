// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  birthDate DateTime @map("birth_date")
  gender    String
  bloodType String?  @map("blood_type")
  height    Float?
  weight    Float?
  
  // Lifestyle habits stored as JSON
  lifestyleHabits Json? @map("lifestyle_habits")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  healthRecords        HealthRecord[]
  medicalRecords       MedicalRecord[]
  medications          Medication[]
  genomicData          GenomicData[]
  familyHistory        FamilyHistory[]
  familyRiskAssessments FamilyRiskAssessment[]
  documents            Document[]
  predictions          Prediction[]
  appointments         Appointment[]
  
  @@map("users")
}

model HealthRecord {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  recordType   String   @map("record_type")
  data         Json
  recordedDate DateTime @map("recorded_date")
  createdAt    DateTime @default(now()) @map("created_at")
  
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  vitalSigns VitalSign[]
  
  @@map("health_records")
}

model VitalSign {
  id              String   @id @default(cuid())
  healthRecordId  String   @map("health_record_id")
  type            String
  value           Json
  unit            String
  measuredAt      DateTime @map("measured_at")
  
  healthRecord HealthRecord @relation(fields: [healthRecordId], references: [id], onDelete: Cascade)
  
  @@map("vital_signs")
}

model MedicalRecord {
  id                   String   @id @default(cuid())
  userId               String   @map("user_id")
  hospitalName         String   @map("hospital_name")
  department           String
  doctorName           String   @map("doctor_name")
  diagnosisCode        String?  @map("diagnosis_code")
  diagnosisDescription String?  @map("diagnosis_description")
  doctorNotes          String?  @map("doctor_notes")
  cost                 Float?
  visitDate            DateTime @map("visit_date")
  createdAt            DateTime @default(now()) @map("created_at")
  
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  testResults  TestResult[]
  prescriptions Prescription[]
  
  @@map("medical_records")
}

model TestResult {
  id              String   @id @default(cuid())
  medicalRecordId String   @map("medical_record_id")
  testCategory    String   @map("test_category") // blood, urine, imaging, etc.
  testSubcategory String?  @map("test_subcategory") // cbc, liver_function, etc.
  testName        String   @map("test_name")
  testItems       Json     @map("test_items") // Array of TestItem objects
  overallStatus   String   @map("overall_status") // normal, abnormal, critical, etc.
  testDate        DateTime @map("test_date")
  laboratoryName  String?  @map("laboratory_name")
  doctorNotes     String?  @map("doctor_notes")
  imageFiles      Json?    @map("image_files") // Array of file paths for imaging tests
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  medicalRecord MedicalRecord @relation(fields: [medicalRecordId], references: [id], onDelete: Cascade)
  
  @@index([testCategory, testDate])
  @@index([testName, testDate])
  @@index([overallStatus])
  @@map("test_results")
}

model Prescription {
  id              String   @id @default(cuid())
  medicalRecordId String   @map("medical_record_id")
  medicationName  String   @map("medication_name")
  dosage          String
  frequency       String
  duration        String?
  instructions    String?
  
  medicalRecord MedicalRecord @relation(fields: [medicalRecordId], references: [id], onDelete: Cascade)
  
  @@map("prescriptions")
}

model Medication {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  name        String
  genericName String?   @map("generic_name")
  dosage      String
  frequency   String
  route       String?   // oral, injection, topical, etc.
  startDate   DateTime  @map("start_date")
  endDate     DateTime? @map("end_date")
  isActive    Boolean   @default(true) @map("is_active")
  purpose     String?   // indication for use
  prescribedBy String?  @map("prescribed_by")
  pharmacy    String?
  notes       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  dosageLogs         DosageLog[]
  sideEffects        SideEffect[]
  medicationSchedules MedicationSchedule[]
  
  @@map("medications")
}

model DosageLog {
  id           String   @id @default(cuid())
  medicationId String   @map("medication_id")
  takenAt      DateTime @map("taken_at")
  dosageTaken  String   @map("dosage_taken")
  notes        String?
  
  medication Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  
  @@map("dosage_logs")
}

model SideEffect {
  id           String   @id @default(cuid())
  medicationId String   @map("medication_id")
  effectName   String   @map("effect_name")
  severity     String   // mild, moderate, severe
  description  String?
  startDate    DateTime @map("start_date")
  endDate      DateTime? @map("end_date")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  
  medication Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  
  @@map("side_effects")
}

model DrugInteraction {
  id                String   @id @default(cuid())
  drug1Name         String   @map("drug1_name")
  drug2Name         String   @map("drug2_name")
  interactionType   String   @map("interaction_type") // major, moderate, minor
  severity          String   // contraindicated, serious, significant, minor
  description       String
  clinicalEffect    String?  @map("clinical_effect")
  mechanism         String?
  management        String?
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@index([drug1Name, drug2Name])
  @@index([interactionType])
  @@map("drug_interactions")
}

model MedicationSchedule {
  id           String   @id @default(cuid())
  medicationId String   @map("medication_id")
  timeOfDay    String   @map("time_of_day") // morning, afternoon, evening, night
  scheduledTime String  @map("scheduled_time") // HH:MM format
  dosage       String
  instructions String?
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  
  medication Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  
  @@map("medication_schedules")
}

model GenomicData {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  sourcePlatform   String   @map("source_platform")
  filePath         String?  @map("file_path")
  snpData          Json?    @map("snp_data")
  analysisResults  Json?    @map("analysis_results")
  uploadedAt       DateTime @default(now()) @map("uploaded_at")
  
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  riskAssessments RiskAssessment[]
  
  @@map("genomic_data")
}

model RiskAssessment {
  id                 String   @id @default(cuid())
  userId             String   @map("user_id")
  genomicDataId      String?  @map("genomic_data_id")
  diseaseType        String   @map("disease_type")
  riskScore          Float    @map("risk_score")
  percentile         Float?
  contributingFactors Json?   @map("contributing_factors")
  calculatedAt       DateTime @default(now()) @map("calculated_at")
  
  genomicData GenomicData? @relation(fields: [genomicDataId], references: [id], onDelete: SetNull)
  
  @@map("risk_assessments")
}

model FamilyHistory {
  id           String  @id @default(cuid())
  userId       String  @map("user_id")
  relationship String  // father, mother, sibling, child, grandparent, etc.
  name         String?
  gender       String? // male, female, unknown
  birthYear    Int?    @map("birth_year")
  deathYear    Int?    @map("death_year")
  isAlive      Boolean @default(true) @map("is_alive")
  
  // Family tree positioning
  generation   Int     @default(0) // 0 = user, -1 = parents, -2 = grandparents, +1 = children
  position     Int     @default(0) // position within generation for layout
  parentId     String? @map("parent_id") // reference to parent in family tree
  
  // Medical information
  conditions   Json?   // array of medical conditions
  causeOfDeath String? @map("cause_of_death")
  
  // Metadata
  notes        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Self-referencing relationship for family tree structure
  parent   FamilyHistory?  @relation("FamilyTreeRelation", fields: [parentId], references: [id])
  children FamilyHistory[] @relation("FamilyTreeRelation")
  
  @@map("family_history")
}

model GeneticCondition {
  id                String   @id @default(cuid())
  name              String   @unique
  icd10Code         String?  @map("icd10_code")
  category          String   // cardiovascular, cancer, neurological, metabolic, etc.
  inheritancePattern String? @map("inheritance_pattern") // autosomal_dominant, autosomal_recessive, x_linked, etc.
  prevalence        Float?   // population prevalence (0-1)
  penetrance        Float?   // genetic penetrance (0-1)
  description       String?
  riskFactors       Json?    @map("risk_factors") // array of risk factors
  symptoms          Json?    // array of symptoms
  isHereditary      Boolean  @default(false) @map("is_hereditary")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@index([category])
  @@index([isHereditary])
  @@map("genetic_conditions")
}

model FamilyRiskAssessment {
  id                String   @id @default(cuid())
  userId            String   @map("user_id")
  conditionName     String   @map("condition_name")
  familyRiskScore   Float    @map("family_risk_score") // 0-1 scale
  affectedRelatives Int      @map("affected_relatives") // count of affected family members
  riskLevel         String   @map("risk_level") // low, moderate, high, very_high
  recommendations   Json?    // array of recommendations
  calculatedAt      DateTime @default(now()) @map("calculated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, conditionName])
  @@index([riskLevel])
  @@map("family_risk_assessments")
}

model Document {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  fileName    String   @map("file_name")
  filePath    String   @map("file_path")
  fileType    String   @map("file_type")
  category    String?
  ocrText     String?  @map("ocr_text")
  metadata    Json?
  uploadedAt  DateTime @default(now()) @map("uploaded_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("documents")
}

model AIModel {
  id          String   @id @default(cuid())
  name        String
  version     String
  modelType   String   @map("model_type")
  parameters  Json?
  accuracy    Float?
  trainedAt   DateTime @map("trained_at")
  
  predictions Prediction[]
  
  @@map("ai_models")
}

model Prediction {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  aiModelId        String   @map("ai_model_id")
  predictionType   String   @map("prediction_type")
  inputData        Json     @map("input_data")
  predictionResult Json     @map("prediction_result")
  confidenceScore  Float?   @map("confidence_score")
  createdAt        DateTime @default(now()) @map("created_at")
  
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  aiModel AIModel @relation(fields: [aiModelId], references: [id], onDelete: Cascade)
  
  @@map("predictions")
}

model ReferenceRange {
  id           String   @id @default(cuid())
  testName     String   @map("test_name")
  testCategory String   @map("test_category")
  unit         String?
  ageMin       Int?     @map("age_min")
  ageMax       Int?     @map("age_max")
  gender       String?  // 'male', 'female', 'all'
  minValue     Float?   @map("min_value")
  maxValue     Float?   @map("max_value")
  textRange    String?  @map("text_range") // For non-numeric ranges like "negative"
  source       String?  // Reference institution
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  @@index([testName, testCategory])
  @@index([testCategory])
  @@map("reference_ranges")
}

model Appointment {
  id                String   @id @default(cuid())
  userId            String   @map("user_id")
  hospitalName      String   @map("hospital_name")
  department        String
  doctorName        String?  @map("doctor_name")
  appointmentType   String   @map("appointment_type") // consultation, follow_up, procedure, test
  purpose           String?  // reason for appointment
  appointmentDate   DateTime @map("appointment_date")
  duration          Int?     // duration in minutes
  status            String   @default("scheduled") // scheduled, confirmed, completed, cancelled, no_show
  location          String?  // room number, building, etc.
  notes             String?
  
  // Contact information
  hospitalPhone     String?  @map("hospital_phone")
  hospitalAddress   String?  @map("hospital_address")
  
  // Reminder settings
  reminderSettings  Json?    @map("reminder_settings") // notification preferences
  
  // Metadata
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications     AppointmentNotification[]
  
  @@index([userId, appointmentDate])
  @@index([status])
  @@index([department])
  @@map("appointments")
}

model AppointmentNotification {
  id            String   @id @default(cuid())
  appointmentId String   @map("appointment_id")
  notificationType String @map("notification_type") // email, sms, push, in_app
  scheduledTime DateTime @map("scheduled_time") // when to send the notification
  message       String?
  status        String   @default("pending") // pending, sent, failed
  sentAt        DateTime? @map("sent_at")
  errorMessage  String?  @map("error_message")
  createdAt     DateTime @default(now()) @map("created_at")
  
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  
  @@index([scheduledTime, status])
  @@map("appointment_notifications")
}